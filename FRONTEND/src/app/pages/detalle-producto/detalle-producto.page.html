<div class="detalle-container" *ngIf="!cargando && producto">
  <h1 class="detalle-titulo">Ficha Técnica Producto</h1>
  <img class="detalle-imagen" [src]="getImagePath(producto) || 'assets/img/default.png'" [alt]="producto.nombre" />
  <h2>{{ producto.nombre }}</h2>
  <p class="descripcion">{{ producto.descripcion }}</p>
  <p class="precio">${{ producto.precio | number:'1.0-0' }}</p>
  <p *ngIf="producto.especificaciones" class="especificaciones">{{ producto.especificaciones }}</p>
  <button *ngIf="!esAdmin" class="agregar-boton" (click)="agregarAlCarrito()">Agregar al carrito</button>

  <!-- Solo para administrador -->
  <ng-container *ngIf="esAdmin">
    <!-- Selector de sucursal solo para seleccionar y ver stock -->
    <div class="selector-sucursal">
      <label for="sucursal">Sucursal:</label>
      <select id="sucursal" [(ngModel)]="sucursalSeleccionada" (change)="onSucursalChange(producto.id)">
        <option *ngFor="let suc of sucursales" [ngValue]="suc">{{ suc.nombre }}</option>
      </select>
    </div>
    <div class="stock-sucursal">
      <ng-container *ngIf="inventario && inventario.stock != null; else sinStock">
        Stock disponible: {{ inventario.stock }}
      </ng-container>
      <ng-template #sinStock>
        Sin stock en esta sucursal
      </ng-template>
    </div>

    <!-- Formulario editable de datos del producto (excepto stock y sucursal) -->
    <form class="form-editar-producto">
      <h3>Editar datos del producto</h3>
      <label>Código: <span>{{ producto.codigo }}</span></label>
      <label>Nombre: <input [(ngModel)]="producto.nombre" name="nombre"></label>
      <label>Descripción: <textarea [(ngModel)]="producto.descripcion" name="descripcion"></textarea></label>
      <label>Precio: <input type="number" [(ngModel)]="producto.precio" name="precio"></label>
      <label>Categoría:
        <select [(ngModel)]="producto.categoriaId" name="categoriaId">
          <option *ngFor="let cat of categorias" [value]="cat.id">{{ cat.nombre }}</option>
        </select>
      </label>
      <label>Marca:
        <select [(ngModel)]="producto.marcaId" name="marcaId">
          <option [ngValue]="null">Sin marca / Otro</option>
          <option *ngFor="let marca of marcas" [value]="marca.id">{{ marca.nombre }}</option>
        </select>
      </label>
      <!-- Imagen URL oculto, solo mostrar imagen y botón -->
      <div style="grid-column: 1 / -1; display: flex; align-items: center; gap: 1.2rem; margin: 0.7rem 0;">
        <img [src]="getImagePath(producto)" [alt]="producto.nombre" style="width: 80px; height: 80px; object-fit: contain; border-radius: 0.7rem; background: #f5f5f5;">
        <button type="button" style="background:#e0e0e0;color:#263238;border:none;padding:0.6rem 1.2rem;border-radius:0.7rem;cursor:pointer;">Cambiar imagen</button>
      </div>
      <label>Especificaciones: <textarea [(ngModel)]="producto.especificaciones" name="especificaciones"></textarea></label>
      <label>Activo: <input type="checkbox" [(ngModel)]="producto.activo" name="activo"></label>
      <button type="button" (click)="guardarCambios()" style="background:#4CAF50;color:white;border:none;padding:0.8rem 1.5rem;border-radius:0.7rem;cursor:pointer;font-weight:500;">Guardar cambios</button>
    </form>
  </ng-container>
</div>

<!-- ⏳ Spinner mientras carga -->
<div class="spinner-center" *ngIf="cargando">
  <ion-spinner name="crescent"></ion-spinner>
</div>
